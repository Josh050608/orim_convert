#!/usr/bin/env python3
"""
æµ‹è¯•è„šæœ¬ï¼šç›´æ¥è§£ç äºŒè¿›åˆ¶æ¯”ç‰¹æµ
ç”¨äºéªŒè¯ ORIMProtocol.decode_stream çš„è§£ç èƒ½åŠ›
"""

import sys
import os

# æ·»åŠ è·¯å¾„ä»¥ä¾¿å¯¼å…¥ protocol
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'orim_engine'))

from core.protocol import ORIMProtocol

def test_decode_bitstream(bitstream: str):
    """
    æµ‹è¯•è§£ç æŒ‡å®šçš„æ¯”ç‰¹æµ
    
    Args:
        bitstream: äºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "0000011000100110010001"
    """
    print("="*70)
    print("ORIM Protocol Bitstream Decoder Test")
    print("="*70)
    print(f"\n[è¾“å…¥] æ¯”ç‰¹æµé•¿åº¦: {len(bitstream)} bits")
    print(f"[è¾“å…¥] å‰100ä¸ªæ¯”ç‰¹: {bitstream[:100]}...")
    print(f"[è¾“å…¥] å®Œæ•´æ¯”ç‰¹æµ:\n{bitstream}\n")
    
    # è°ƒç”¨è§£ç å‡½æ•°
    print("[æ‰§è¡Œ] è°ƒç”¨ ORIMProtocol.decode_stream()...")
    cid, consumed = ORIMProtocol.decode_stream(bitstream)
    
    print(f"\n[ç»“æœ] è§£ç çŠ¶æ€: {'âœ… æˆåŠŸ' if cid else 'âŒ æœªæ‰¾åˆ°æœ‰æ•ˆå¸§'}")
    
    if cid:
        print(f"[ç»“æœ] è§£ç å‡ºçš„ CID: {cid}")
        print(f"[ç»“æœ] æ¶ˆè€—çš„æ¯”ç‰¹æ•°: {consumed}")
        print(f"[ç»“æœ] CID é•¿åº¦: {len(cid)} å­—ç¬¦")
        print(f"[ç»“æœ] å‰©ä½™æ¯”ç‰¹æ•°: {len(bitstream) - consumed}")
        
        # æ˜¾ç¤ºå‰©ä½™çš„æ¯”ç‰¹æµ
        if consumed < len(bitstream):
            remaining = bitstream[consumed:]
            print(f"[ç»“æœ] å‰©ä½™æ¯”ç‰¹æµ: {remaining[:50]}..." if len(remaining) > 50 else f"[ç»“æœ] å‰©ä½™æ¯”ç‰¹æµ: {remaining}")
        else:
            print(f"[ç»“æœ] æ¯”ç‰¹æµå·²å®Œå…¨æ¶ˆè€—")
            
        # éªŒè¯ CID æ ¼å¼
        if cid.startswith("Qm") and len(cid) == 46:
            print(f"\n[éªŒè¯] âœ… CID æ ¼å¼æ­£ç¡® (ä»¥Qmå¼€å¤´ï¼Œé•¿åº¦46)")
        else:
            print(f"\n[éªŒè¯] âš ï¸ CID æ ¼å¼å¼‚å¸¸")
            
    else:
        print(f"[ç»“æœ] æœªæ‰¾åˆ°æœ‰æ•ˆçš„å¸§")
        print(f"[æç¤º] å¯èƒ½åŸå› :")
        print(f"  1. æ¯”ç‰¹æµé•¿åº¦ä¸è¶³ (éœ€è¦è‡³å°‘ {ORIMProtocol.FRAME_BITS_LEN} bits)")
        print(f"  2. æœªæ‰¾åˆ° Magic å¤´ (0xCAFE = {ORIMProtocol.MAGIC_BIN})")
        print(f"  3. CRC æ ¡éªŒå¤±è´¥")
        print(f"  4. Payload ä¸æ˜¯æœ‰æ•ˆçš„ UTF-8 å­—ç¬¦ä¸²")
    
    print("\n" + "="*70)

def test_valid_frame():
    """æµ‹è¯•ä¸€ä¸ªæœ‰æ•ˆçš„å®Œæ•´å¸§"""
    print("\n\n### æµ‹è¯•æ¡ˆä¾‹ 1: æœ‰æ•ˆçš„å®Œæ•´ CID å¸§ ###\n")
    
    # ç”Ÿæˆä¸€ä¸ªæœ‰æ•ˆçš„å¸§
    test_cid = "QmYwAPJzv5CZsnAzt8auVZRnrU7V5B3x2mE3Dwn"  # 46å­—ç¬¦
    packed_bits = ORIMProtocol.pack_cid(test_cid)
    
    print(f"[ç”Ÿæˆ] åŸå§‹ CID: {test_cid}")
    print(f"[ç”Ÿæˆ] æ‰“åŒ…åæ¯”ç‰¹æµé•¿åº¦: {len(packed_bits)} bits")
    
    # è§£ç 
    test_decode_bitstream(packed_bits)

def test_noisy_frame():
    """æµ‹è¯•å¸¦å™ªéŸ³çš„å¸§ï¼ˆå‰é¢æœ‰åƒåœ¾æ•°æ®ï¼‰"""
    print("\n\n### æµ‹è¯•æ¡ˆä¾‹ 2: å¸¦å‰å¯¼å™ªéŸ³çš„å¸§ ###\n")
    
    test_cid = "QmYwAPJzv5CZsnAzt8auVZRnrU7V5B3x2mE3Dwn"
    packed_bits = ORIMProtocol.pack_cid(test_cid)
    
    # åœ¨å‰é¢åŠ ä¸Šéšæœºå™ªéŸ³
    noise = "10101010111100001010101011110000"
    noisy_stream = noise + packed_bits
    
    print(f"[ç”Ÿæˆ] åŸå§‹ CID: {test_cid}")
    print(f"[ç”Ÿæˆ] å‰å¯¼å™ªéŸ³: {noise} ({len(noise)} bits)")
    
    test_decode_bitstream(noisy_stream)

def test_user_input():
    """æµ‹è¯•ç”¨æˆ·æä¾›çš„æ¯”ç‰¹æµ"""
    print("\n\n### æµ‹è¯•æ¡ˆä¾‹ 3: ç”¨æˆ·æä¾›çš„æ¯”ç‰¹æµ ###\n")
    
    # ç”¨æˆ·çš„æµ‹è¯•å­—ç¬¦ä¸²
    user_bitstream = "0000011000100110010001"
    test_decode_bitstream(user_bitstream)

def test_insufficient_bits():
    """æµ‹è¯•é•¿åº¦ä¸è¶³çš„æ¯”ç‰¹æµ"""
    print("\n\n### æµ‹è¯•æ¡ˆä¾‹ 4: é•¿åº¦ä¸è¶³çš„æ¯”ç‰¹æµ ###\n")
    
    short_stream = "1100101011111110" + "0" * 100  # åªæœ‰ 116 bitsï¼Œä¸å¤Ÿä¸€ä¸ªå®Œæ•´å¸§
    test_decode_bitstream(short_stream)

if __name__ == "__main__":
    print("\nğŸ”¬ ORIM Protocol è§£ç æµ‹è¯•å·¥å…·\n")
    
    if len(sys.argv) > 1:
        # å¦‚æœæä¾›äº†å‘½ä»¤è¡Œå‚æ•°ï¼Œè§£ç å‚æ•°ä¸­çš„æ¯”ç‰¹æµ
        bitstream = "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000010111111001001111111110101110000101010101100110111010001001000011000010111001101101000001100100110010001100110011010000110101001101100011011100111000001110010011000000110001001100100011001100110100001101010011011000110111001100000111001001100000011000100110010001100110011010000110101001101100011011100111000001110010011000000110001001100100011001100110100011001001111011011000000000000000000000000000000000000000000000000000000010011110100001101111000101001001000011110110011101110000011000101000101011011100101010011001100000111010100000110101000000000011110101110001001010110000011001101010101010100100101010101001000010100010111001101110110010001100110110101001110001101110110110101101101010101100100101101010011001100110100100001110001000110001101010110111001100010111100100110001001101010110000100110001101011010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        print(f"[æ¨¡å¼] å‘½ä»¤è¡Œè¾“å…¥æ¨¡å¼\n")
        test_decode_bitstream(bitstream)
    else:
        # è¿è¡Œæ‰€æœ‰æµ‹è¯•æ¡ˆä¾‹
        print(f"[æ¨¡å¼] è‡ªåŠ¨æµ‹è¯•æ¨¡å¼ï¼ˆè¿è¡Œæ‰€æœ‰æ¡ˆä¾‹ï¼‰\n")
        
        test_valid_frame()
        test_noisy_frame()
        test_user_input()
        test_insufficient_bits()
        
        print("\n\n" + "="*70)
        print("æ‰€æœ‰æµ‹è¯•å®Œæˆï¼")
        print("="*70)
        print("\nğŸ’¡ æç¤º: è¿è¡Œ 'python3 test_decode_bitstream.py <æ¯”ç‰¹æµ>' å¯æµ‹è¯•è‡ªå®šä¹‰æ¯”ç‰¹æµ")
