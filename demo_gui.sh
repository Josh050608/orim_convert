#!/bin/bash

# ORIM GUI ç«¯åˆ°ç«¯æ¼”ç¤ºè„šæœ¬
# æ­¤è„šæœ¬å¸®åŠ©ç”¨æˆ·å¿«é€Ÿä½“éªŒ Alice to Bob æ–‡ä»¶ä¼ è¾“æµç¨‹

set -e

echo "=========================================="
echo "ðŸŽ¬ ORIM ç«¯åˆ°ç«¯æ–‡ä»¶ä¼ è¾“æ¼”ç¤º"
echo "=========================================="
echo ""

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="$(cd "$(dirname "$0")" && pwd)"
STORAGE_DIR="$PROJECT_ROOT/storage"
DB_PATH="$STORAGE_DIR/orim.db"

echo -e "${BLUE}ðŸ“ é¡¹ç›®ç›®å½•: $PROJECT_ROOT${NC}"
echo ""

# 1. æ£€æŸ¥ IPFS daemon
echo -e "${YELLOW}ðŸ” æ­¥éª¤ 1/5: æ£€æŸ¥ IPFS daemon...${NC}"
if pgrep -x "ipfs" > /dev/null; then
    echo -e "${GREEN}âœ… IPFS daemon æ­£åœ¨è¿è¡Œ${NC}"
else
    echo -e "${RED}âŒ IPFS daemon æœªè¿è¡Œ${NC}"
    echo -e "${YELLOW}æ­£åœ¨å¯åŠ¨ IPFS daemon...${NC}"
    nohup ipfs daemon > /tmp/ipfs_daemon.log 2>&1 &
    sleep 3
    echo -e "${GREEN}âœ… IPFS daemon å·²å¯åŠ¨${NC}"
fi
echo ""

# 2. åˆ›å»ºæµ‹è¯•æ–‡ä»¶
echo -e "${YELLOW}ðŸ“ æ­¥éª¤ 2/5: åˆ›å»ºæµ‹è¯•æ–‡ä»¶...${NC}"
TEST_FILE="/tmp/alice_demo_file.txt"
cat > "$TEST_FILE" << 'EOF'
ðŸ” æœºå¯†æ–‡æ¡£ - ORIM æ¼”ç¤º

å‘ä»¶äºº: Alice
æ”¶ä»¶äºº: Bob
æ—¥æœŸ: 2025-12-18

è¿™æ˜¯ä¸€ä¸ªé€šè¿‡ ORIM éšè”½ä¿¡é“ä¼ è¾“çš„æµ‹è¯•æ–‡ä»¶ã€‚

æŠ€æœ¯ç‰¹ç‚¹ï¼š
âœ“ ç«¯åˆ°ç«¯åŠ å¯†ï¼ˆAES-256ï¼‰
âœ“ IPFS åˆ†å¸ƒå¼å­˜å‚¨
âœ“ åŒºå—é“¾éšè”½ä¼ è¾“
âœ“ å®Œå…¨éšè”½ï¼ˆå¤–éƒ¨æ— æ³•æ£€æµ‹ï¼‰

ä¼ è¾“æµç¨‹ï¼š
1. æ–‡ä»¶åŠ å¯†å¹¶ä¸Šä¼ åˆ° IPFS
2. èŽ·å¾—å†…å®¹æ ‡è¯†ç¬¦ï¼ˆCIDï¼‰
3. CID é€šè¿‡æ¯”ç‰¹å¸äº¤æ˜“ä¼ è¾“
4. æŽ¥æ”¶æ–¹è§£ç  CID
5. ä»Ž IPFS ä¸‹è½½å¹¶è§£å¯†

çŠ¶æ€: æµ‹è¯•æˆåŠŸ âœ…
EOF

FILE_SIZE=$(wc -c < "$TEST_FILE")
echo -e "${GREEN}âœ… æµ‹è¯•æ–‡ä»¶å·²åˆ›å»º: $TEST_FILE${NC}"
echo -e "   å¤§å°: $FILE_SIZE bytes"
echo ""

# 3. æ£€æŸ¥æ•°æ®åº“
echo -e "${YELLOW}ðŸ—„ï¸  æ­¥éª¤ 3/5: æ£€æŸ¥æ•°æ®åº“...${NC}"
if [ ! -f "$DB_PATH" ]; then
    echo -e "${RED}âŒ æ•°æ®åº“ä¸å­˜åœ¨: $DB_PATH${NC}"
    echo -e "${YELLOW}è¯·å…ˆè¿è¡Œ ./start_demo.sh åˆå§‹åŒ–ç³»ç»Ÿ${NC}"
    exit 1
fi

# ç»Ÿè®¡æ¶ˆæ¯æ•°é‡
OUTGOING_COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM outgoing_messages")
DECODED_COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM decoded_messages")
echo -e "${GREEN}âœ… æ•°æ®åº“è¿žæŽ¥æˆåŠŸ${NC}"
echo -e "   å¾…å‘é€æ¶ˆæ¯: $OUTGOING_COUNT"
echo -e "   å·²æŽ¥æ”¶æ¶ˆæ¯: $DECODED_COUNT"
echo ""

# 4. æ˜¾ç¤ºä½¿ç”¨è¯´æ˜Ž
echo -e "${YELLOW}ðŸ“– æ­¥éª¤ 4/5: GUI ä½¿ç”¨è¯´æ˜Ž${NC}"
echo ""
echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${BLUE}â”‚  Alice æ“ä½œï¼ˆå·¦ä¾§çª—å£ï¼‰                  â”‚${NC}"
echo -e "${BLUE}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
echo -e "${BLUE}â”‚  1. ç‚¹å‡» 'ðŸ“ é€‰æ‹©æ–‡ä»¶'                   â”‚${NC}"
echo -e "${BLUE}â”‚  2. é€‰æ‹©æµ‹è¯•æ–‡ä»¶:                        â”‚${NC}"
echo -e "${BLUE}â”‚     $TEST_FILE${NC}"
echo -e "${BLUE}â”‚  3. ç‚¹å‡» 'ðŸš€ åŠ å¯†å¹¶ä¸Šä¼ '                 â”‚${NC}"
echo -e "${BLUE}â”‚  4. æŸ¥çœ‹ç”Ÿæˆçš„ CIDï¼ˆåŒå‡»å¯å¤åˆ¶ï¼‰         â”‚${NC}"
echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""
echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${BLUE}â”‚  Bob æ“ä½œï¼ˆå³ä¾§çª—å£ï¼‰                    â”‚${NC}"
echo -e "${BLUE}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
echo -e "${BLUE}â”‚  1. ç­‰å¾…æŽ¥æ”¶ CIDï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰             â”‚${NC}"
echo -e "${BLUE}â”‚  2. é€‰ä¸­æŽ¥æ”¶åˆ°çš„ CID                     â”‚${NC}"
echo -e "${BLUE}â”‚  3. ç‚¹å‡» 'â¬‡ï¸ ä¸‹è½½é€‰ä¸­æ–‡ä»¶'               â”‚${NC}"
echo -e "${BLUE}â”‚  4. æ–‡ä»¶ä¿å­˜åˆ°: storage/downloads/       â”‚${NC}"
echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

# 5. å¯åŠ¨ GUI
echo -e "${YELLOW}ðŸš€ æ­¥éª¤ 5/5: å¯åŠ¨ GUI...${NC}"
echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}GUI çª—å£å³å°†æ‰“å¼€${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# ç­‰å¾…ç”¨æˆ·ç¡®è®¤
echo -e "${YELLOW}æŒ‰ Enter é”®å¯åŠ¨ GUIï¼Œæˆ–æŒ‰ Ctrl+C å–æ¶ˆ...${NC}"
read -r

cd "$PROJECT_ROOT/orim_engine"
source ~/miniconda3/bin/activate orim_env
python3 orim_gui.py

echo ""
echo -e "${GREEN}âœ… GUI å·²å…³é—­${NC}"
echo -e "${BLUE}æ„Ÿè°¢ä½¿ç”¨ ORIM æ–‡ä»¶ä¼ è¾“ç³»ç»Ÿï¼${NC}"
